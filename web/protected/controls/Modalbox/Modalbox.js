if(Object.isUndefined(Prototype.Browser.IE6)){Prototype.Browser.IE6=(navigator.appName.indexOf("Microsoft Internet Explorer")!=-1&&navigator.appVersion.indexOf("MSIE 6.0")!=-1&&!window.XMLHttpRequest)}if(!window.Modalbox){var Modalbox={}}Modalbox.Methods={overrideAlert:false,focusableElements:[],currFocused:0,initialized:false,active:true,options:{title:"ModalBox Window",overlayClose:true,width:500,height:90,overlayOpacity:0.65,overlayDuration:0.25,slideDownDuration:0.5,slideUpDuration:0.5,resizeDuration:0.25,inactiveFade:true,transitions:true,loadingString:"Please wait. Loading...",closeString:"Close window",closeValue:"&times;",params:{},method:"get",autoFocusing:true,aspnet:false,resizeCSSID:""},_options:{},setOptions:function(a){Object.extend(this.options,a||{})},_init:function(c){Object.extend(this._options,this.options);this.setOptions(c);this.MBoverlay=new Element("div",{id:"MB_overlay",style:"opacity: 0"});this.MBwindowwrapper=new Element("div",{id:"MB_windowwrapper"}).update(this.MBwindow=new Element("div",{id:"MB_window",style:"display: none"}).update(this.MBframe=new Element("div",{id:"MB_frame"}).update(this.MBheader=new Element("div",{id:"MB_header"}).update(this.MBcaption=new Element("div",{id:"MB_caption"})))));this.MBclose=new Element("a",{id:"MB_close",title:this.options.closeString,href:"#"}).update("<span>"+this.options.closeValue+"</span>");this.MBheader.insert({bottom:this.MBclose});this.MBcontent=new Element("div",{id:"MB_content"}).update(this.MBloading=new Element("div",{id:"MB_loading"}).update(this.options.loadingString));this.MBframe.insert({bottom:this.MBcontent});var b=this.options.aspnet?$(document.body).down("form"):$(document.body);b.insert({top:this.MBwindowwrapper});b.insert({top:this.MBoverlay});var a=document.viewport.getScrollOffsets();if(a[1]>0){$("MB_window").setStyle({top:a[1]+"px"})}if(a[0]>0){$("MB_window").setStyle({left:a[0]+"px"})}Event.observe(window,"scroll",function(){a=document.viewport.getScrollOffsets();$("MB_window").setStyle({top:a[1]+"px"});$("MB_window").setStyle({left:a[0]+"px"})});this.initScrollX=window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft;this.initScrollY=window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop;this.hideObserver=this._hide.bindAsEventListener(this);this.kbdObserver=this._kbdHandler.bindAsEventListener(this);this.resizeObserver=this._setWidthAndPosition.bindAsEventListener(this);this._initObservers();this.initialized=true},show:function(b,a){if(!this.initialized){this._init(a)}this._cleanUpContentIDs();this.content=b;this.setOptions(a);if(this.options.title){this.MBcaption.update(this.options.title)}else{this.MBheader.hide();this.MBcaption.hide()}if(this.MBwindow.style.display=="none"){this._appear();this.event("onShow")}else{this._update();this.event("onUpdate")}},hide:function(a){if(this.initialized){if(a&&!Object.isFunction(a.element)){Object.extend(this.options,a)}this.event("beforeHide");if(this.options.transitions){Effect.SlideUp(this.MBwindow,{duration:this.options.slideUpDuration,transition:Effect.Transitions.sinoidal,afterFinish:this._deinit.bind(this)})}else{this.MBwindow.hide();this._deinit()}Event.stopObserving(window,"scroll")}else{throw ("Modalbox is not initialized.")}},_hide:function(a){a.stop();if(a.element().id=="MB_overlay"&&!this.options.overlayClose){return false}this.hide()},alert:function(b){var a='<div class="MB_alert"><p>'+b+'</p><input type="button" onclick="Modalbox.hide()" value="OK" /></div>';Modalbox.show(a,{title:"Alert: "+document.title,width:300})},_appear:function(){if(Prototype.Browser.IE6){window.scrollTo(0,0);this._prepareIEHtml("100%","hidden");this._prepareIESelects("hidden")}this._setWidth();if(this.options.transitions){this.MBoverlay.setOpacity(0);new Effect.Fade(this.MBoverlay,{from:0,to:this.options.overlayOpacity,duration:this.options.overlayDuration,afterFinish:(function(){new Effect.SlideDown(this.MBwindow,{duration:this.options.slideDownDuration,transition:Effect.Transitions.sinoidal,afterFinish:this.loadContent.bind(this)})}).bind(this)})}else{this.MBoverlay.setOpacity(this.options.overlayOpacity);this.MBwindow.show();this.loadContent()}Event.observe(window,"resize",this.resizeObserver)},resize:function(f,b,p){var o=$(this.MBoverlay).getWidth();var n=$(this.MBwindow).getHeight();var i=$(this.MBwindow).getWidth();var g=$(this.MBheader).getHeight();var m=$(this.MBcontent).getHeight();var a=((n-g+b)<m)?(m+g):(n+b);var e=$(this.MBwindow);var c=$(this.MBcontent);var l=10;a+=l;var k=(parseInt(e.getStyle("margin-top"),0)+parseInt(e.getStyle("margin-bottom"),0)+parseInt(e.getStyle("border-top-width"),0)+parseInt(e.getStyle("border-bottom-width"),0))+l;var d=(parseInt(c.getStyle("padding-top"))+parseInt(c.getStyle("padding-bottom")));if((a+k+d)>document.viewport.getHeight()){a=document.viewport.getHeight()-k-l;newcHeight=a-g-parseInt($(this.MBframe).getStyle("padding-bottom"),0)-parseInt($(this.MBcontent).getStyle("padding-bottom"),0);$(this.MBcontent).setStyle({height:newcHeight+"px"})}else{if($(this.MBcontent).getStyle("height")){$(this.MBcontent).setStyle({height:""})}}var j=i+f;var h={width:j+"px",height:a+"px"};this.options.width=j;if(p){this.setOptions(p)}if(this.options.transitions&&!Modalbox.animating){Modalbox.animating=true;new Effect.Morph(this.MBwindow,{style:h,duration:this.options.resizeDuration,beforeStart:function(q){q.element.setStyle({overflow:"hidden"})},afterFinish:(function(q){q.element.setStyle({overflow:"visible"});this.event("_afterResize");this.event("afterResize");Modalbox.animating=false}).bind(this)})}else{this.MBwindow.setStyle(h);(function(){this.event("_afterResize");this.event("afterResize")}).bind(this).defer()}},resizeToContent:function(c){if(typeof c=="undefined"){c={}}var f=$("MB_content").select("img");var e=f.length;if(f[0]){if(typeof c.imagesloaded=="undefined"){var a=$A();var b=0;f.each(function(i,h){a[h]=new Image();a[h].src=i.src;a[h].onload=function(){b++;if(b==e){var j=false;f.each(function(k){if(k.height==0){j=true}});if(j||Modalbox.animating){Modalbox.resizeToContent()}else{c.imagesloaded=true;Modalbox.resizeToContent(c)}}}})}}var d=0,g=this.options.height-this.MBwindow.getHeight();if(c.resizeCSSID&&$(c.resizeCSSID)){d=$(c.resizeCSSID).getWidth()-$(this.MBwindow).getWidth()+(parseInt($(this.MBcontent).getStyle("padding-left"),0)+parseInt($(this.MBcontent).getStyle("padding-right"),0))+15}if(g!=0){this.resize(d,g,c)}},resizeToInclude:function(c,b){var d=$(c);var a=d.getHeight()+parseInt(d.getStyle("margin-top"),0)+parseInt(d.getStyle("margin-bottom"),0)+parseInt(d.getStyle("border-top-width"),0)+parseInt(d.getStyle("border-bottom-width"),0);if(a>0){this.resize(0,a,b)}},_update:function(){this.MBcontent.update($(this.MBloading).update(this.options.loadingString));this.loadContent()},loadContent:function(){if(this.event("beforeLoad")!=false){if(typeof this.content=="string"){var a=new RegExp(/<\/?[^>]+>/gi);if(a.test(this.content)){this._processContent(this.content)}else{new Ajax.Request(this.content,{method:this.options.method.toLowerCase(),parameters:this.options.params,onComplete:(function(b){this._processContent(b.responseText)}).bind(this),onException:function(b,c){Modalbox.hide();throw ("Modalbox Loading Error: "+c)}})}}else{if(typeof this.content=="object"){this._insertContent(this.content)}else{this.hide();throw ("Modalbox Parameters Error: Please specify correct URL or HTML element (plain HTML or object)")}}}},_processContent:function(content){var html=content.stripScripts(),scripts=content.extractScripts();this._insertContent(html,function(){scripts.map(function(script){return eval(script.replace("<!--","").replace("// -->",""))},window)})},_insertContent:function(b,c){this.MBcontent.hide().update();if(typeof b=="string"){this.MBcontent.insert(new Element("div",{style:"display: none"}).update(b)).down().show()}else{if(typeof b=="object"){var a=b.cloneNode(true);if(b.id){b.id="MB_"+b.id}$(b).select("*[id]").each(function(d){d.id="MB_"+d.id});this.MBcontent.insert(a).down("div").show();if(Prototype.Browser.IE6){this._prepareIESelects("","#MB_content ")}}}if(this.options.height==this._options.height){this.resize((this.options.width-$(this.MBwindow).getWidth()),this.MBcontent.getHeight()-$(this.MBwindow).getHeight()+this.MBheader.getHeight(),{afterResize:(function(){this._putContent.bind(this,c).defer()}).bind(this)})}else{this._setWidth();this.MBcontent.setStyle({overflow:"auto",height:this.MBwindow.getHeight()-this.MBheader.getHeight()-13+"px"});this._putContent.bind(this,c).defer()}},_putContent:function(a){this.MBcontent.show();this._findFocusableElements();this._setFocus();if(Object.isFunction(a)){a()}this.event("afterLoad")},activate:function(a){this.setOptions(a);this.active=true;if(this.options.overlayClose){this.MBoverlay.observe("click",this.hideObserver)}this.MBclose.observe("click",this.hideObserver).show();if(this.options.transitions&&this.options.inactiveFade){new Effect.Appear(this.MBwindow,{duration:this.options.slideUpDuration})}},deactivate:function(a){this.setOptions(a);this.active=false;if(this.options.overlayClose){this.MBoverlay.stopObserving("click",this.hideObserver)}this.MBclose.stopObserving("click",this.hideObserver).hide();if(this.options.transitions&&this.options.inactiveFade){new Effect.Fade(this.MBwindow,{duration:this.options.slideUpDuration,to:0.75})}},_initObservers:function(){this.MBclose.observe("click",this.hideObserver);if(this.options.overlayClose){this.MBoverlay.observe("click",this.hideObserver)}var a=(Prototype.Browser.Gecko||Prototype.Browser.Opera)?"keypress":"keydown";Event.observe(document,a,this.kbdObserver)},_removeObservers:function(){this.MBclose.stopObserving("click",this.hideObserver);if(this.options.overlayClose){this.MBoverlay.stopObserving("click",this.hideObserver)}var a=(Prototype.Browser.Gecko||Prototype.Browser.Opera)?"keypress":"keydown";Event.stopObserving(document,a,this.kbdObserver)},_setFocus:function(){if(this.options.autoFocusing){if(this.focusableElements.length){var a=this.focusableElements.find(function(b){return b.tabIndex==1})||this.focusableElements.first();this.currFocused=this.focusableElements.toArray().indexOf(a);a.focus()}else{if(this.MBclose.visible()){this.MBclose.focus()}}}},_findFocusableElements:function(){this.focusableElements=this.MBcontent.select("input:not([type=hidden]):enabled, select, textarea, button, a[href]")},_kbdHandler:function(c){var b=c.element();switch(c.keyCode){case Event.KEY_TAB:c.stop();this._findFocusableElements();if(!this.focusableElements.length){return false}if(b!=this.focusableElements[this.currFocused]){this.currFocused=this.focusableElements.indexOf(b)}if(!c.shiftKey){if(this.currFocused>=this.focusableElements.length-1){this.currFocused=0}else{this.currFocused++}}else{if(this.currFocused<=0){this.currFocused=this.focusableElements.length-1}else{this.currFocused--}}this.focusableElements[this.currFocused].focus();break;case Event.KEY_ESC:if(this.active){this._hide(c)}break;case 32:this._preventScroll(c);break;case 0:if(c.which==32){this._preventScroll(c)}break;case Event.KEY_UP:case Event.KEY_DOWN:case Event.KEY_PAGEDOWN:case Event.KEY_PAGEUP:case Event.KEY_HOME:case Event.KEY_END:var a=b.tagName.toLowerCase();if(Prototype.Browser.WebKit&&!["textarea","select"].include(a)){c.stop()}else{if((a=="input"&&["submit","button"].include(b.type))||(a=="a")){c.stop()}}break}},_preventScroll:function(a){if(!["input","textarea","select","button"].include(a.element().tagName.toLowerCase())){a.stop()}},_deinit:function(){this._removeObservers();Event.stopObserving(window,"resize",this.resizeObserver);if(this.options.transitions){Effect.toggle(this.MBoverlay,"appear",{duration:this.options.overlayDuration,afterFinish:this._removeElements.bind(this)})}else{this.MBoverlay.hide();this._removeElements()}this.MBcontent.setStyle({overflow:"",height:""})},_cleanUpContentIDs:function(){if(typeof this.content=="object"){if(this.content.id&&this.content.id.match(/MB_/)){this.content.id=this.content.id.replace(/MB_/,"")}this.content.select("*[id]").each(function(a){a.id=a.id.replace(/MB_/,"")})}},_removeElements:function(){if(Prototype.Browser.Opera){window.scrollBy(0,0)}this.MBoverlay.remove();$(this.MBwindowwrapper).remove();if(Prototype.Browser.IE6){this._prepareIEHtml("","");this._prepareIESelects("");window.scrollTo(this.initScrollX,this.initScrollY)}this._cleanUpContentIDs();this.initialized=false;this.event("afterHide");this.setOptions(this._options)},_setWidth:function(){this.MBwindow.setStyle({width:this.options.width+"px",height:this.options.height+"px"})},_setWidthAndPosition:function(){this.MBwindow.setStyle({width:this.options.width+"px"})},_prepareIEHtml:function(a,b){$$("html, body").invoke("setStyle",{width:a,height:a,overflow:b})},_prepareIESelects:function(a,b){$$((b||"")+"select").invoke("setStyle",{visibility:a})},event:function(a){var c=true;if(this.options[a]){var b=this.options[a]();this.options[a]=null;if(!Object.isUndefined(b)){c=b}}return c}};Object.extend(Modalbox,Modalbox.Methods);if(Modalbox.overrideAlert){window.alert=Modalbox.alert};